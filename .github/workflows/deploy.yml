# Nome do nosso "rob么"
name: Deploy Laravel via FTP para Locaweb

# Gatilho: rodar sempre que houver um 'push' na branch 'main'
on:
  push:
    branches:
      - main

jobs:
  # Define o trabalho que o rob么 vai fazer
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
    # Passo 1: Baixar o seu c贸digo do GitHub para o ambiente do rob么
    - name:  Baixando o c贸digo do reposit贸rio
      uses: actions/checkout@v2

    # Passo 2: Configurando o PHP
    - name:  Configurando o PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Lembre-se de usar a mesma vers茫o da sua hospedagem

    # Passo 3: Instalando depend锚ncias do Composer
    - name:  Instalando depend锚ncias do Composer
      run: composer install --optimize-autoloader --no-dev

    # Passo 4: Configurando o Node.js
    - name:  Configurando o Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # Passo 5: Instalando depend锚ncias NPM e compilando os assets
    - name:  Instalando depend锚ncias NPM e compilando os assets
      run: |
        npm install
        npm run build

    # Passo 6: (NOVO!) Limpando arquivos desnecess谩rios antes do deploy
    # Como n茫o podemos usar 'exclude', apagamos as pastas que n茫o devem ir para o servidor.
    - name: Ч Limpando arquivos antes do deploy
      run: rm -rf .git .github node_modules

    # Passo 7: ENVIAR O NCLEO DO PROJETO
    # Agora ele envia tudo o que sobrou ap贸s a limpeza.
    - name:  Enviando arquivos principais para a pasta /laravel_app
      uses: locaweb/ftp-deploy@1.0.0
      with:
        host: ${{ secrets.HOST }} 
        user: ${{ secrets.USER }}
        password: ${{ secrets.PASS }}
        localDir: "."
        remoteDir: "laravel_app"

    # Passo 8: ENVIAR O CONTEDO DA PASTA PUBLIC
    # Este passo continua o mesmo, pois j谩 enviava o diret贸rio correto.
    - name:  Enviando a pasta public para a pasta /public_html
      uses: locaweb/ftp-deploy@1.0.0
      with:
        host: ${{ secrets.HOST }} 
        user: ${{ secrets.USER }}
        password: ${{ secrets.PASS }}
        localDir: "public"
        remoteDir: "public_html"