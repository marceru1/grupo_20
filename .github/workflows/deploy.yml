# Nome do nosso "robô"
name: Deploy Laravel via FTP para Locaweb

# Gatilho: rodar sempre que houver um 'push' na branch 'main'
on:
  push:
    branches:
      - main

jobs:
  # Define o trabalho que o robô vai fazer
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
    # Passo 1: Baixar o seu código do GitHub para o ambiente do robô
    - name: 🚚 Baixando o código do repositório
      uses: actions/checkout@v2

    # Passo 2: Configurando o PHP
    - name: 🐘 Configurando o PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Lembre-se de usar a mesma versão da sua hospedagem

    # Passo 3: Instalando dependências do Composer
    - name: 📦 Instalando dependências do Composer
      run: composer install --optimize-autoloader --no-dev

    # Passo 4: Configurando o Node.js
    - name: 🎨 Configurando o Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # Passo 5: Instalando dependências NPM e compilando os assets
    - name: 🔨 Instalando dependências NPM e compilando os assets
      run: |
        npm install
        npm run build

    # Passo 6: (NOVO!) Limpando arquivos desnecessários antes do deploy
    # Como não podemos usar 'exclude', apagamos as pastas que não devem ir para o servidor.
    - name: 🧹 Limpando arquivos antes do deploy
      run: rm -rf .git .github node_modules

    # Passo 7: ENVIAR O NÚCLEO DO PROJETO
    # Agora ele envia tudo o que sobrou após a limpeza.
    - name: 🚀 Enviando arquivos principais para a pasta /laravel_app
      uses: locaweb/ftp-deploy@1.0.0
      with:
        host: ${{ secrets.HOST }} 
        user: ${{ secrets.USER }}
        password: ${{ secrets.PASS }}
        localDir: "."
        remoteDir: "laravel_app"

    # Passo 8: ENVIAR O CONTEÚDO DA PASTA PUBLIC
    # Este passo continua o mesmo, pois já enviava o diretório correto.
    - name: 🚀 Enviando a pasta public para a pasta /public_html
      uses: locaweb/ftp-deploy@1.0.0
      with:
        host: ${{ secrets.HOST }} 
        user: ${{ secrets.USER }}
        password: ${{ secrets.PASS }}
        localDir: "public"
        remoteDir: "public_html"