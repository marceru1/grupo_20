# Nome do nosso "rob么" que aparecer谩 no GitHub
name: Deploy Laravel via FTP para Locaweb

# Gatilho: Diz quando o rob么 deve come莽ar a trabalhar.
# Neste caso, sempre que houver um 'push' (envio de c贸digo) para a branch 'main'.
on:
  push:
    branches:
      - main

# "jobs" define as tarefas que o rob么 vai executar.
jobs:
  deploy:
    # Nome da tarefa
    name: Deploy
    # O rob么 usar谩 um computador virtual com Ubuntu para fazer o trabalho.
    runs-on: ubuntu-latest

    # "steps" 茅 a lista de passos sequenciais que o rob么 deve seguir.
    steps:
    # Passo 1: O rob么 come莽a baixando a vers茫o mais recente do seu c贸digo.
    - name:  Baixando o c贸digo do reposit贸rio
      uses: actions/checkout@v2

    # Passo 2: O rob么 instala e configura o PHP para poder usar o Composer.
    - name:  Configurando o PHP
      uses: shivammathur/setup-php@v2
      with:
        # PONTO DE ATENO: Verifique no painel da Locaweb qual a sua vers茫o
        # do PHP e coloque o n煤mero correto aqui (ex: '8.1', '8.2', etc).
        php-version: '8.2' 

    # Passo 3: O rob么 instala as depend锚ncias do Laravel.
    - name:  Instalando depend锚ncias do Composer
      run: composer install --optimize-autoloader --no-dev

    # Passo 4: O rob么 instala o Node.js para poder compilar os assets.
    - name:  Configurando o Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # Passo 5: O rob么 instala os pacotes do NPM e compila os arquivos CSS e JS.
    - name:  Instalando depend锚ncias NPM e compilando os assets
      run: |
        npm install
        npm run build

    # Passo 6: O rob么 envia o "n煤cleo" do Laravel para a pasta correta no servidor.
    - name:  Enviando arquivos principais para a pasta /laravel_app
      uses: locaweb/ftp-deploy@1.0.0
      with:
        host: ${{ secrets.HOST }} 
        user: ${{ secrets.USER }}
        password: ${{ secrets.PASS }}
        localDir: "." # A origem 茅 a pasta inteira do projeto.
        remoteDir: "laravel_app" # O destino 茅 a pasta 'laravel_app' no servidor.
        # Exclu铆mos o que n茫o precisa ser enviado ou o que ser谩 enviado depois.
        exclude: ".git, .github, node_modules, public"

    # Passo 7: O rob么 envia o conte煤do da pasta 'public' para a pasta 'public_html'.
    - name:  Enviando a pasta public para a pasta /public_html
      uses: locaweb/ftp-deploy@1.0.0
      with:
        host: ${{ secrets.HOST }} 
        user: ${{ secrets.USER }}
        password: ${{ secrets.PASS }}
        localDir: "public" # A origem 茅 apenas a pasta 'public'.
        remoteDir: "public_html" # O destino 茅 a pasta 'public_html' no servidor.